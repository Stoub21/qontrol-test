
# Qontrol Test

## Context

To apply for an [Inria position](https://newsletter.gdr-robotique.org/?n=1cd560ec416116b25a1e0abba41ddd21) for the [Extender project of Orthopus](https://orthopus.com/fr/), I have to install and experiment with the [Qontrol tool](https://gitlab.inria.fr/auctus-team/components/control/qontrol).

Specifically, my task is to:
- Install Qontrol
- Run one of the existing examples
- Modify it to move a robot
  - Start with a shift forward of 0.1 m along the x-axis
  - Follow with a shift backward of 0.2 m along the z-axis
- Finally, I have to submit this report of my work through Git, explaining my choices and steps in English.

## Steps

### Installation

On the installation website, it is specified that the tool is only compatible with Ubuntu 20.04 and 22.04. As I currently use Ubuntu 24.04, I will have to use [Docker](https://www.docker.com/) or a VM (I chose Docker).

So, I generated a [Dockerfile](Dockerfile) to create a suitable environment.

I have never worked with [MuJoCo](https://mujoco.org/) and [Pinocchio](https://stack-of-tasks.github.io/pinocchio/), so I had some documentation to review.

I can build my Docker image with the command 
`docker build -t qontrol .`
And run it with the command 
`docker run -it --rm --gpus all -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix -v .:/home --device=/dev/dri:/dev/dri qontrol`

- I have a GPU, and it seems useful for the simulation and MuJoCo. With the [Nvidia Container Toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html), I give access to the GPUs to the container (and I use a Docker image with CUDA (**CUDA could be incompatible due to your GPU**)).
- To give access to the screen to the container, I have to add X11 Forwarding options (`-e ...`, `-v ...`, and `--device` options), but I also have to grant permission to do that before running the container with the command `xhost +`.

When the container starts, I can launch the simulation by moving to the path `qontrol/build/examples` and running the command: 
`./velocityQontrol panda`

### Understanding the Qontrol Function

By reading the documentation and examining the code, it seems to be used to set some rules for the task of parameter reversal.

Each function (`velocityQontrol`, `QontrolCustomConstraint`, `QontrolCustomTask`, `torqueQontrol`, `Qontrol_qpmad`) needs a path description for the end effector of the chosen robot (`panda` or `ur5`). The code will, for each line of the plan path, compare the position of the end effector to the target and use a corrector to achieve a target error. Finally, the Qontrol function will use this output target to describe the motor commands. The way it uses this output target is defined in each example in the documentation.

### Use

To adapt the current work to a specific path, I just have to generate the `trajectory.csv` file that contains the path planning.

When I read this file, I saw that 19 parameters are required for each point:
- 3 for the Cartesian position
- 4 for the quaternion orientation
- 3 for the Cartesian speed
- 3 for the Euler angles speed
- 3 for the Cartesian acceleration
- 3 for the Euler angles acceleration

However, the position matrix (the first 7 parameters) is enough for `velocityQontrol`, `Qontrol_qpmad`, `QontrolCustomTask`, and `QontrolCustomConstraint`, and for `torqueQontrol`, position and speed are enough.

So, I wrote a [Python script](trajectory_gen.py) that generates a `trajectory.csv` file with only position settings based on the number of points (equivalent to the time, as each point is supposed to be executed every 10 ms) and a direction vector.

For easier utilization, I also generated two scripts to update the trajectory path and to launch the simulation.

The trajectory can be defined directly in the Python script.

To generate and replace the `trajectory.csv` file of a chosen robot, you can run the command `./update_trajectory.sh panda` (or `ur5`), and that will replace the trajectory file with the one generated by Python.

To launch a simulation, you can use the command `./launch_Qontrol.sh velocityQontrol ur5` (or any of the functions with any robot). This command navigates to the `qontrol/build/examples` path (necessary to launch a function) and launches the desired function.

### Result

The trajectory currently generated by the Python code respects the task of starting with an x shift of 0.1 m and finishing with a z shift of -0.2 m.

## Further Work

Even though I managed to make the robot follow the specified trajectory, I have not fully understood the problem and solution method described by the Qontrol tool. Therefore, there are some points that could be interesting to explore further:

- Extract the robot state values to analyze them for each control method
- Add more tasks and/or constraints

## Bibliography

- [QP Solver - *Wikipedia*](https://en.wikipedia.org/wiki/Quadratic_programming)
- [Hessian matrix - *Wikipedia*](https://en.wikipedia.org/wiki/Hessian_matrix)
- I was helped by ChatGPT and Mistral LLM to write the code and improve my report.